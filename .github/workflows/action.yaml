name: accuknox-jobs Workflow


on:
  push:
    tags:
    - "v[0-9]+.[0-9]+.[0-9]+"
    - "v[0-9]+.[0-9]+.[0-9]+-*"
  pull_request_target:
    branches:
    - "*"


env:
  REPO: public.ecr.aws/k9v9d5v2
  IMAGE_NAME: accuknox-cis-k8s
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_DEV_ACCESS_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_DEV_SECRET_ID }} 
  SLACK_WEBHOOK_URL:  ${{ secrets.SLACK_WEBHOOK_URL }}
  AWS_REGION: us-east-1
  
jobs:
  tag-validate:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - uses: rubenesp87/semver-validation-action@0.1.0
      with:
       version: ${{ github.ref_name }}
       

  docker-image-scan:
    runs-on: ubuntu-latest
    needs: [tag-validate]
    if: always() && !contains(needs.tag-validate.result, 'failure') && !contains(needs.go.result, 'failure')
    steps:
    - name: Checkout source
      uses: accuknox/common-gh-actions/actions/checkout-source@main 
    - name: Set git ssh private key
      run: echo "${{ secrets.GIT_KEY }}" > GIT-KEY     
    - name: Docker build and Trivy scan
      uses: accuknox/common-gh-actions/actions/docker-scan@main
      with:
        repo: ${{ env.REPO }}
        image-name: ${{ env.IMAGE_NAME }}
        tag: ${{ github.run_number }}
        args: --build-arg VERSION=${{ github.run_number }}
        s3-bucket-name: accuknox-trivy-scan-reports
        trivy-exit-code: 0
        trivy-severity: HIGH,CRITICAL

  docker-image-push:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [docker-image-scan]
    steps:
    - name: Checkout source
      uses: accuknox/common-gh-actions/actions/checkout-source@main
    - name: Set git ssh private key
      run: echo "${{ secrets.GIT_KEY }}" > GIT-KEY 
    - name: Docker build and Push image to ECR
      uses: accuknox/common-gh-actions/actions/docker-push@main
      with:
        repo: ${{ env.REPO }}
        image-name: ${{ env.IMAGE_NAME }}
        tag: ${{ github.ref_name }}
        args: --build-arg VERSION=${{ github.ref_name }}
        type: public